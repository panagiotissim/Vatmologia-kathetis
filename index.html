<!doctype html>
<html lang="el">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Î‘Î¸Î»Î·Ï„Î¹ÎºÎ® Î‘Î»Î¹ÎµÎ¯Î± - ÎšÎ±Î¸ÎµÏ„Î®</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root {
    --bg:#0f172a;
    --card:#111827;
    --ink:#e5e7eb;
    --muted:#9ca3af;
    --accent:#22c55e;
    --danger:#ef4444;
    --warn:#f59e0b;
    --line:#1f2937;
  }

  *{box-sizing:border-box;}

  body{
    margin:0;
    background:linear-gradient(120deg,#020617,#0f172a);
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
  }

  header{
    padding:16px;
    border-bottom:1px solid var(--line);
    background:rgba(15,23,42,.9);
    backdrop-filter:blur(6px);
    position:sticky;
    top:0;
    z-index:10;
  }

  h1{margin:0;font-size:18px;}

  nav{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:8px;
  }

  nav button{
    padding:10px 14px;
    border-radius:12px;
    border:1px solid #273244;
    background:#020617;
    color:var(--ink);
    cursor:pointer;
    min-height:40px;
    font-size:14px;
  }

  nav button.active{
    background:var(--accent);
    color:#052e16;
    border-color:transparent;
    font-weight:700;
  }

  .wrap{
    max-width:1200px;
    margin:16px auto;
    padding:0 16px;
  }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:12px;
    padding:16px;
    margin-bottom:16px;
  }

  .row{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .row>*{ flex:1; }

  label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px;}

  input,select,button{
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid #273244;
    background:#020617;
    color:var(--ink);
    font-size:14px;
  }

  button.primary{background:var(--accent);color:#052e16;border-color:transparent;font-weight:600;cursor:pointer;}
  button.ghost{background:#020617;cursor:pointer;}
  button.warn{background:#f59e0b;color:#111827;border-color:transparent;}
  button.danger{background:#ef4444;color:#fff;border-color:transparent;}

  .muted{color:var(--muted);}
  .small{font-size:12px;}

  .pill{
    display:inline-block;
    padding:5px 9px;
    border-radius:999px;
    background:#020617;
    border:1px solid #1f2937;
    font-size:11px;
    margin:2px 4px 0 0;
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:8px;
  }

  th,td{
    border-bottom:1px solid var(--line);
    padding:6px 8px;
    text-align:left;
    white-space:nowrap;
    font-size:12px;
  }

  th{color:var(--muted);font-weight:600;}

  .table-wrap{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }

  .table-wrap table{min-width:900px;}

  @media (max-width:900px){
    .row{flex-direction:column;}
  }

  /* ğŸ”¥ ÎœÎµÎ³Î¬Î»Î± ÎºÎ¿Ï…Ï„Î¬ÎºÎ¹Î± Î•Î™Î”Î™ÎšÎ‘ Î³Î¹Î± Ï„Î·Î½ ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î® */
  .field-input{
  width:100%;
  padding:10px 8px;
  border-radius:8px;
  border:1px solid #273244;
  background:#ffffff;
  color:#000000;
  font-size:20px;
  min-height:40px;
  box-sizing:border-box;
  text-align:right;       /* Î¿Î¹ Î±ÏÎ¹Î¸Î¼Î¿Î¯ Î´ÎµÎ¾Î¹Î¬ */
  font-family: monospace; /* ÏƒÏ„Î±Î¸ÎµÏÏŒ Ï€Î»Î¬Ï„Î¿Ï‚, Ï†Î±Î¯Î½Î¿Î½Ï„Î±Î¹ ÎºÎ±Î¸Î±ÏÎ¬ */
}
/* ÎŸÎ¹ ÏƒÏ„Î®Î»ÎµÏ‚ Cat1â€“Cat5 Î½Î± ÎµÎ¯Î½Î±Î¹ Ï€Î¹Î¿ Ï†Î±ÏÎ´Î¹Î­Ï‚ */
#resultsTableWrap table th:nth-child(6),
#resultsTableWrap table th:nth-child(7),
#resultsTableWrap table th:nth-child(8),
#resultsTableWrap table th:nth-child(9),
#resultsTableWrap table th:nth-child(10),
#resultsTableWrap table td:nth-child(6),
#resultsTableWrap table td:nth-child(7),
#resultsTableWrap table td:nth-child(8),
#resultsTableWrap table td:nth-child(9),
#resultsTableWrap table td:nth-child(10){
  min-width:70px;
}


  .field-input[type=number]::-webkit-inner-spin-button,
  .field-input[type=number]::-webkit-outer-spin-button{
    -webkit-appearance:none;
    margin:0;
  }
  .field-input[type=number]{
    -moz-appearance:textfield;
    appearance:textfield;
  }
</style>
</head>

<body>

<header>
  <h1>ğŸ£ Î‘Î¸Î»Î·Ï„Î¹ÎºÎ® Î‘Î»Î¹ÎµÎ¯Î± - ÎšÎ±Î¸ÎµÏ„Î®</h1>
  <nav id="topNav">
    <button data-page="p-participants" class="active">Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Î¿Î½Ï„ÎµÏ‚</button>
    <button data-page="p-draw">Î—Î¼Î­ÏÎµÏ‚ & ÎšÎ»Î®ÏÏ‰ÏƒÎ·</button>
    <button data-page="p-entry">ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î®</button>
    <button data-page="p-scores">Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯ÎµÏ‚</button>
  </nav>
</header>


<div class="wrap">
  <!-- --- Î£Î•Î›Î™Î”Î‘ Î£Î¥ÎœÎœÎ•Î¤Î•Î§ÎŸÎÎ¤Î©Î --- -->
  <section id="p-participants" class="page">
    <div class="card">
      <h2>Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Î¿Î½Ï„ÎµÏ‚</h2>

      <div class="row">
        <div>
          <label>ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿</label>
          <input id="athName" placeholder="Ï€.Ï‡. ÎÎ¯ÎºÎ¿Ï‚ Î Î±Ï€Î±Î´ÏŒÏ€Î¿Ï…Î»Î¿Ï‚">
        </div>
        <div>
          <label>Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</label>
          <input id="athClub" placeholder="Ï€.Ï‡. Î.ÎŸ. Î ÏŒÎ»Î·Ï‚">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>Î‘Ï. ÎœÎ·Ï„ÏÏÎ¿Ï…</label>
          <input id="athReg" placeholder="Ï€.Ï‡. 12345">
        </div>
        <div>
          <label>Î§Î¿ÏÎ·Î³ÏŒÏ‚</label>
          <input id="athSponsor" placeholder="Ï€.Ï‡. Shimano">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="primary" id="addAthleteBtn">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
        <input id="excelInput" type="file" accept=".xlsx,.xls,.csv" style="display:none">
        <button class="warn" id="excelBtn">ğŸ—‚ï¸ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Î±Ï€ÏŒ Excel</button>
      </div>

      <div class="small muted" style="margin-top:4px">
        Excel/CSV: ÏƒÏ„Î®Î»ÎµÏ‚ <code>ÎŒÎ½Î¿Î¼Î±, Î£ÏÎ»Î»Î¿Î³Î¿Ï‚, Î‘Ï. ÎœÎ·Ï„ÏÏÎ¿Ï…, Î§Î¿ÏÎ·Î³ÏŒÏ‚</code>
      </div>
    </div>

    <div class="card">
      <h2>Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</h2>

      <div class="row">
        <div>
          <label>ÎŒÎ½Î¿Î¼Î± Î´Î¹Î¿ÏÎ³Î¬Î½Ï‰ÏƒÎ·Ï‚</label>
          <input id="eventName" placeholder="Ï€.Ï‡. Î ÏÏ‰Ï„Î¬Î¸Î»Î·Î¼Î± ÎšÎ±Î¸ÎµÏ„Î®Ï‚">
        </div>
        <div>
          <label>Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï„Î¿Î¼Î­Ï‰Î½</label>
          <input id="numSectors" type="number" min="1" max="26" value="5">
        </div>
      </div>

      <div class="small muted" style="margin-top:6px">
        ÎŸÎ¹ Î±Î¸Î»Î·Ï„Î­Ï‚ Î¼Î¿Î¹ÏÎ¬Î¶Î¿Î½Ï„Î±Î¹ Î¹ÏƒÏŒÏ€Î¿ÏƒÎ± ÏŒÏƒÎ¿ Î³Î¯Î½ÎµÏ„Î±Î¹ ÏƒÏ„Î¿Ï…Ï‚ Ï„Î¿Î¼ÎµÎ¯Ï‚ (A,B,C...)<br>
        Î ÏÎ¿ÏƒÏ€Î±Î¸ÎµÎ¯ Î½Î± ÎºÏÎ±Ï„Î¬ÎµÎ¹ Î±Î¸Î»Î·Ï„Î­Ï‚ Î¯Î´Î¹Î¿Ï… ÏƒÏ…Î»Î»ÏŒÎ³Î¿Ï… Ï‡Ï‰ÏÎ¹ÏƒÏ„Î¬ â€“ ÎµÎºÏ„ÏŒÏ‚ Î±Î½ Î´ÎµÎ½ Î³Î¯Î½ÎµÏ„Î±Î¹.
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button class="ghost" id="saveStateBtn">ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
        <button class="ghost" id="loadStateBtn">ğŸ“‚ Î¦ÏŒÏÏ„Ï‰ÏƒÎ·</button>
        <button class="danger" id="resetBtn">ğŸ§¹ ÎœÎ·Î´ÎµÎ½Î¹ÏƒÎ¼ÏŒÏ‚</button>
      </div>
    </div>

    <div class="card">
      <h2>Î›Î¯ÏƒÏ„Î± ÏƒÏ…Î¼Î¼ÎµÏ„ÎµÏ‡ÏŒÎ½Ï„Ï‰Î½</h2>
      <div class="table-wrap" id="athletesTableWrap"></div>
    </div>
  </section>

  <!-- --- Î£Î•Î›Î™Î”Î‘ ÎšÎ›Î—Î¡Î©Î£Î—Î£ --- -->
  <section id="p-draw" class="page" style="display:none">
    <div class="card">
      <h2>Î—Î¼Î­ÏÎµÏ‚</h2>
      <button class="primary" id="addDayBtn">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î·Î¼Î­ÏÎ±Ï‚</button>
      <div class="pill small" style="margin-top:8px">Î•Î½ÎµÏÎ³Î® Î·Î¼Î­ÏÎ±:</div>
      <div id="daysTabs" style="margin-top:4px"></div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center;justify-content:space-between">
        <h2>ÎšÎ»Î®ÏÏ‰ÏƒÎ· Ï„Î¿Î¼Î­Ï‰Î½ & Î¸Î­ÏƒÎµÏ‰Î½</h2>

        <div class="row" style="flex:0;gap:6px">
          <button class="primary" id="drawBtn">ğŸ² ÎšÎ»Î®ÏÏ‰ÏƒÎ·</button>
          <button class="ghost" id="clearDrawBtn">â†©ï¸ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
          <button class="ghost" id="exportDrawBtn">â¬‡ï¸ Î•Î¾Î±Î³Ï‰Î³Î® Excel</button>
        </div>
      </div>

      <div id="sectorInfo" class="small muted" style="margin-top:4px"></div>

      <div class="table-wrap" id="drawTableWrap" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- --- Î£Î•Î›Î™Î”Î‘ ÎšÎ‘Î¤Î‘Î“Î¡Î‘Î¦Î—Î£ --- -->
  <section id="p-entry" class="page" style="display:none">
    <div class="card">
      <h2>ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Î·Î¼Î­ÏÎ±Ï‚ â€” ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚ 1â€“5</h2>

      <div class="small muted">
        ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± 1 = 1 Î²Î±Î¸Î¼ÏŒÏ‚ / ÏˆÎ¬ÏÎ¹  
        ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± 2 = 2 Î²Î±Î¸Î¼Î¿Î¯ / ÏˆÎ¬ÏÎ¹  
        ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± 3 = 3 Î²Î±Î¸Î¼Î¿Î¯ / ÏˆÎ¬ÏÎ¹  
        ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± 4 = 4 Î²Î±Î¸Î¼Î¿Î¯ / ÏˆÎ¬ÏÎ¹  
        ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± 5 = 5 Î²Î±Î¸Î¼Î¿Î¯ / ÏˆÎ¬ÏÎ¹  
        <br><br>
        <b>ÎšÎ±Ï„Î¬Ï„Î±Î¾Î· Î·Î¼Î­ÏÎ±Ï‚:</b>  
        1) Î ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ¿Î¹ Î²Î±Î¸Î¼Î¿Î¯ Ï€Î¿Î¹Î½Î®Ï‚  
        2) Î ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± ÏˆÎ¬ÏÎ¹Î±  
        3) ÎœÎµÎ³Î±Î»ÏÏ„ÎµÏÎ¿ Î±Î»Î¯ÎµÏ…Î¼Î±  
      </div>

      <div class="table-wrap" id="resultsTableWrap" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- --- Î£Î•Î›Î™Î”Î‘ Î’Î‘Î˜ÎœÎŸÎ›ÎŸÎ“Î™Î©Î --- -->
  <section id="p-scores" class="page" style="display:none">
    <div class="card">
      <div class="row" style="align-items:center;justify-content:space-between">
        <h2>Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯ÎµÏ‚</h2>
        <button class="primary" id="exportScoresBtn">â¬‡ï¸ Î•Î¾Î±Î³Ï‰Î³Î® Excel</button>
      </div>

      <div id="scoreTabs" style="margin-top:8px"></div>
      <div class="table-wrap" id="scoreTables"></div>
    </div>
  </section>
</div>

<script>
/* ================= Î’ÎŸÎ—Î˜Î—Î¤Î™ÎšÎ‘ ================= */
function $(id){return document.getElementById(id);}
function uid(){return Math.random().toString(36).slice(2,9);}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function safe(s){s = s==null ? "" : String(s); return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

/* ================= ÎšÎ‘Î¤Î‘Î£Î¤Î‘Î£Î— ================= */
let state = {
  settings: {
    eventName: "",
    numSectors: 5
  },
  athletes: [],
  days: [],
  activeDayId: null
};

function save(){localStorage.setItem("fishing_katheti_v4",JSON.stringify(state));}
function load(){
  const raw=localStorage.getItem("fishing_katheti_v4");
  if(!raw) return false;
  state = JSON.parse(raw);
  return true;
}
function activeDay(){return state.days.find(d=>d.id===state.activeDayId)||null;}
function sectorLabels(){
  const n=Math.max(1,Math.min(26,Number(state.settings.numSectors)||1));
  const arr=[];
  for(let i=0;i<n;i++) arr.push(String.fromCharCode(65+i));
  return arr;
}

/* ================= Î Î›ÎŸÎ—Î“Î—Î£Î— ================= */
function showPage(pid){
  document.querySelectorAll(".page").forEach(p=>p.style.display=(p.id===pid?"block":"none"));
  document.querySelectorAll("#topNav button").forEach(b=>b.classList.toggle("active",b.getAttribute("data-page")===pid));
  renderAll();
}
document.getElementById("topNav").addEventListener("click",e=>{
  if(e.target.tagName==="BUTTON") showPage(e.target.dataset.page);
});

/* ================= Î£Î¥ÎœÎœÎ•Î¤Î•Î§ÎŸÎÎ¤Î•Î£ ================= */
function renderAthletes(){
  const wrap=$("athletesTableWrap");
  if(!state.athletes.length){
    wrap.innerHTML='<p class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ…Î¼Î¼ÎµÏ„Î­Ï‡Î¿Î½Ï„ÎµÏ‚.</p>';
    return;
  }
  let html='<table><thead><tr><th>#</th><th>ÎŒÎ½Î¿Î¼Î±</th><th>Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</th><th>Î‘Ï. ÎœÎ·Ï„ÏÏÎ¿Ï…</th><th>Î§Î¿ÏÎ·Î³ÏŒÏ‚</th><th></th></tr></thead><tbody>';
  state.athletes.forEach((a,i)=>{
    html+=`<tr>
      <td>${i+1}</td>
      <td>${safe(a.name)}</td>
      <td>${safe(a.club||"")}</td>
      <td>${safe(a.regNo||"")}</td>
      <td>${safe(a.sponsor||"")}</td>
      <td><button class="danger" data-del="${a.id}">âœ–</button></td>
    </tr>`;
  });
  html+='</tbody></table>';
  wrap.innerHTML=html;

  wrap.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.dataset.del;
      state.athletes=state.athletes.filter(a=>a.id!==id);
      state.days.forEach(d=>{ if(d.draw) delete d.draw[id]; if(d.results) delete d.results[id]; });
      save(); renderAll();
    };
  });
}

/* ================= Î—ÎœÎ•Î¡Î•Î£ ================= */
function renderDaysTabs(){
  const wrap=$("daysTabs");
  wrap.innerHTML="";
  if(!state.days.length){
    wrap.innerHTML='<span class="muted small">ÎšÎ±Î¼Î¯Î± Î·Î¼Î­ÏÎ± Î±ÎºÏŒÎ¼Î·.</span>';
    return;
  }
  state.days.forEach((d,i)=>{
    const b=document.createElement("button");
    b.className="pill";
    if(d.id===state.activeDayId) b.style.borderColor="#22c55e";
    b.textContent=d.name||`Î—Î¼Î­ÏÎ± ${i+1}`;
    b.onclick=()=>{state.activeDayId=d.id; save(); renderAll();};
    wrap.appendChild(b);
  });
}

/* ================= ÎšÎ›Î—Î¡Î©Î£Î— ================= */
function renderDraw(){
  const wrap=$("drawTableWrap");
  const info=$("sectorInfo");
  const d=activeDay();
  const sectors=sectorLabels();
  info.textContent = `Î¤Î¿Î¼ÎµÎ¯Ï‚: ${sectors.join(", ")} â€” Î£ÏÎ½Î¿Î»Î¿ Î±Î¸Î»Î·Ï„ÏÎ½: ${state.athletes.length}`;
  if(!d){
    wrap.innerHTML='<p class="muted">Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ Î·Î¼Î­ÏÎ±.</p>';
    return;
  }

  const rows=state.athletes.map(a=>({a,dd:d.draw && d.draw[a.id]}))
    .sort((x,y)=>{
      const sx=x.dd?x.dd.sector:"";
      const sy=y.dd?y.dd.sector:"";
      if(sx===sy){
        const px=x.dd?x.dd.peg:999999;
        const py=y.dd?y.dd.peg:999999;
        return px-py;
      }
      return sx.localeCompare(sy);
    });

  let html='<table><thead><tr><th>#</th><th>ÎŒÎ½Î¿Î¼Î±</th><th>Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</th><th>Î¤Î¿Î¼Î­Î±Ï‚</th><th>Î˜Î­ÏƒÎ·</th></tr></thead><tbody>';
  rows.forEach((r,i)=>{
    html+=`<tr>
      <td>${i+1}</td>
      <td>${safe(r.a.name)}</td>
      <td>${safe(r.a.club||"")}</td>
      <td>${r.dd?safe(r.dd.sector):"-"}</td>
      <td>${r.dd?safe(r.dd.peg):"-"}</td>
    </tr>`;
  });
  html+='</tbody></table>';
  wrap.innerHTML=html;
}

function doDraw(){
  const d=activeDay();
  if(!d){alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³Î® Î·Î¼Î­ÏÎ±.");return;}
  const sectors=sectorLabels();
  const N=state.athletes.length;
  if(!N){alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î¸Î»Î·Ï„Î­Ï‚.");return;}

  const S=sectors.length;
  const base=Math.floor(N/S);
  const rem=N%S;

  const capacity=new Map();
  sectors.forEach((s,i)=>capacity.set(s, base+(i<rem?1:0)));
  const buckets=new Map(sectors.map(s=>[s,[]]));
  const clubInSec=new Map(sectors.map(s=>[s,new Set()]));
  const filled=new Map(sectors.map(s=>[s,0]));

  const byClub=new Map();
  state.athletes.forEach(a=>{
    const c=(a.club||"-").trim()||"-";
    if(!byClub.has(c)) byClub.set(c,[]);
    byClub.get(c).push(a);
  });

  const clubs=Array.from(byClub.entries()).sort((a,b)=>b[1].length-a[1].length);
  const ordered=[];
  clubs.forEach(([c,arr])=>{
    shuffle(arr);
    arr.forEach(a=>ordered.push(a));
  });

  function hasRoom(sec){return filled.get(sec)<capacity.get(sec);}
  function place(sec,a){
    buckets.get(sec).push(a.id);
    filled.set(sec,filled.get(sec)+1);
    clubInSec.get(sec).add((a.club||"-").trim());
  }

  ordered.forEach(a=>{
    const c=(a.club||"-").trim()||"-";
    let choices=sectors.filter(s=>hasRoom(s)&&!clubInSec.get(s).has(c));
    if(!choices.length) choices=sectors.filter(s=>hasRoom(s));
    if(!choices.length) return;
    choices.sort((s1,s2)=>filled.get(s1)-filled.get(s2));
    place(choices[0],a);
  });

  d.draw={};
  let pos=1;
  sectors.forEach(sec=>{
    const list=buckets.get(sec)||[];
    shuffle(list);
    list.forEach(id=>{
      d.draw[id]={sector:sec,peg:pos++};
    });
  });
}

/* ================= ÎšÎ‘Î¤Î‘Î“Î¡Î‘Î¦Î— ================= */
function renderResults(){
  const wrap = $("resultsTableWrap");
  const d = activeDay();
  if (!d){
    wrap.innerHTML='<p class="muted">Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ Î·Î¼Î­ÏÎ± & ÎºÎ»Î®ÏÏ‰ÏƒÎ·.</p>';
    return;
  }

  const rows = state.athletes.map(a=>({a,dd:d.draw && d.draw[a.id]}))
    .sort((x,y)=>{
      const sx = x.dd ? x.dd.sector : "";
      const sy = y.dd ? y.dd.sector : "";
      if(sx===sy){
        const px = x.dd ? x.dd.peg : 999999;
        const py = y.dd ? y.dd.peg : 999999;
        return px - py;
      }
      return sx.localeCompare(sy);
    });

  let html = '<table><thead><tr>';
  html += '<th>#</th><th>ÎŒÎ½Î¿Î¼Î±</th><th>Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</th><th>Î¤Î¿Î¼Î­Î±Ï‚</th><th>Î˜Î­ÏƒÎ·</th>';
  html += '<th>Cat1</th><th>Cat2</th><th>Cat3</th><th>Cat4</th><th>Cat5</th>';
  html += '<th>Î£ÏÎ½Î¿Î»Î¿ ÏˆÎ±ÏÎ¹ÏÎ½</th><th>Î’. Î Î¿Î¹Î½Î®Ï‚</th><th>ÎœÎµÎ³. ÏˆÎ¬ÏÎ¹ (g)</th><th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>';
  html += '</tr></thead><tbody>';

  if(!d.results) d.results = {};

  rows.forEach((r,i)=>{
    const id = r.a.id;

    let res = d.results[id];
    if(!res){
      res = {cats:[null,null,null,null,null], biggest:null, status:"OK"};
      d.results[id]=res;
    }
    if(!Array.isArray(res.cats) || res.cats.length!==5){
      res.cats=[null,null,null,null,null];
    }
    if(res.status==null) res.status="OK";

    const cats = res.cats;
    const total   = cats.reduce((s,x)=>s+Number(x||0),0);
    const penalty = cats.reduce((s,x,idx)=>s+Number(x||0)*(idx+1),0);
    const biggestVal  = res.biggest;
    const biggestDisp = (biggestVal==null || biggestVal==="") ? "" : biggestVal;

    html += `<tr data-ath="${id}">
      <td>${i+1}</td>
      <td>${safe(r.a.name)}</td>
      <td>${safe(r.a.club||"")}</td>
      <td>${r.dd ? safe(r.dd.sector) : "-"}</td>
      <td>${r.dd ? safe(r.dd.peg) : "-"}</td>
      ${
        cats.map((v,ci)=>{
          const disp = (v==null || v==="") ? "" : v;
          return `<td>
            <input
              class="field-input"
              type="number"
              min="0"
              data-id="${id}"
              data-f="cat${ci}"
              value="${disp}"
            >
          </td>`;
        }).join("")
      }
      <td data-role="totalFish">${total}</td>
      <td data-role="penalty">${penalty}</td>
      <td>
        <input class="field-input" type="number" min="0"
               data-id="${id}" data-f="biggest" value="${biggestDisp}">
      </td>
      <td>
        <select data-id="${id}" data-f="status">
          <option value="OK" ${res.status==="OK"?"selected":""}>OK</option>
          <option value="DQ" ${res.status==="DQ"?"selected":""}>DQ</option>
          <option value="NS" ${res.status==="NS"?"selected":""}>NS</option>
        </select>
      </td>
    </tr>`;
  });

  html += '</tbody></table>';
  wrap.innerHTML = html;

  // ÎœÎµÎ³Î±Î»ÏÏ„ÎµÏÎ¿ ÏˆÎ¬ÏÎ¹
  wrap.querySelectorAll("input.field-input[data-f='biggest']").forEach(el=>{
    el.addEventListener("input", ()=>{
      const d = activeDay();
      if(!d) return;
      const id    = el.dataset.id;
      if(!d.results[id]) d.results[id]={cats:[null,null,null,null,null],biggest:null,status:"OK"};
      const obj = d.results[id];
      obj.biggest = el.value==="" ? null : Number(el.value);
      save();
      renderScores();
    });
  });

  // ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚ Cat1â€“Cat5
  wrap.querySelectorAll("input.field-input[data-f^='cat']").forEach(el=>{
    el.addEventListener("input", ()=>{
      const d = activeDay();
      if(!d) return;
      const id    = el.dataset.id;
      const field = el.dataset.f;
      if(!d.results[id]) d.results[id]={cats:[null,null,null,null,null],biggest:null,status:"OK"};
      const obj = d.results[id];

      const idx = Number(field.replace("cat",""));
      const val = el.value==="" ? 0 : Number(el.value);
      obj.cats[idx] = isNaN(val) ? 0 : val;

      // ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÏƒÏÎ½Î¿Î»Î¿ & Ï€Î¿Î¹Î½Î® ÎœÎŸÎÎŸ ÏƒÏ„Î· Î³ÏÎ±Î¼Î¼Î®
      const tr = el.closest("tr");
      if(tr){
        const catInputs = tr.querySelectorAll("input.field-input[data-f^='cat'][data-id='"+id+"']");
        let totalFish = 0;
        let penalty   = 0;
        catInputs.forEach(inp=>{
          const f   = inp.dataset.f;
          const i   = Number(f.replace("cat",""));
          const v   = Number(inp.value||0);
          if(!isNaN(v)){
            totalFish += v;
            penalty   += v*(i+1);
          }
        });
        const tdTotal = tr.querySelector('td[data-role="totalFish"]');
        const tdPen   = tr.querySelector('td[data-role="penalty"]');
        if(tdTotal) tdTotal.textContent = totalFish;
        if(tdPen)   tdPen.textContent   = penalty;
      }

      save();
      renderScores();
    });
  });

  // ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· (OK/DQ/NS)
  wrap.querySelectorAll("select[data-f='status']").forEach(sel=>{
    sel.addEventListener("change", ()=>{
      const d = activeDay();
      if(!d) return;
      const id = sel.dataset.id;
      if(!d.results[id]) d.results[id]={cats:[null,null,null,null,null],biggest:null,status:"OK"};
      d.results[id].status = sel.value;
      save();
      renderScores();
    });
  });
}


/* ================= Î¥Î ÎŸÎ›ÎŸÎ“Î™Î£ÎœÎŸÎ™ ================= */
function computeDayRows(dayId){
  const d=state.days.find(x=>x.id===dayId);
  if(!d) return [];

  const rows=[];
  state.athletes.forEach(a=>{
    const dd=d.draw && d.draw[a.id];
    if(!dd) return;

    const res=(d.results && d.results[a.id]) || {cats:[null,null,null,null,null],biggest:null,status:"OK"};
    const cats=res.cats||[null,null,null,null,null];
    const totalFish=cats.reduce((s,x)=>s+Number(x||0),0);
    let penalty=cats.reduce((s,x,idx)=>s+Number(x||0)*(idx+1),0);
    let biggest=Number(res.biggest||0);

    if(res.status!=="OK"){
      penalty = 0;
      biggest = 0;
    }

    rows.push({
      id:a.id,
      name:a.name,
      club:a.club||"",
      regNo:a.regNo||"",
      sponsor:a.sponsor||"",
      sector:dd.sector,
      peg:dd.peg,
      cats:cats.slice(),
      totalFish,
      penalty,
      biggest,
      status:res.status
    });
  });

  rows.sort((a,b)=>{
    return (b.penalty-a.penalty) ||
           (b.totalFish-a.totalFish) ||
           (b.biggest-a.biggest) ||
           a.name.localeCompare(b.name,'el');
  });

  return rows;
}

function computeAggregate(){
  const agg=new Map();

  state.athletes.forEach(a=>{
    agg.set(a.id,{
      id:a.id,
      name:a.name,
      club:a.club||"",
      regNo:a.regNo||"",
      sponsor:a.sponsor||"",
      totalPenalty:0,
      totalFish:0,
      bestBiggest:0
    });
  });

  state.days.forEach(d=>{
    const rows=computeDayRows(d.id);
    const byId=new Map(rows.map(r=>[r.id,r]));

    agg.forEach((v,id)=>{
      const r=byId.get(id);
      if(!r) return;
      v.totalPenalty += r.penalty;
      v.totalFish += r.totalFish;
      v.bestBiggest = Math.max(v.bestBiggest, r.biggest);
    });
  });

  const out=Array.from(agg.values());
  out.sort((a,b)=>{
    return (b.totalPenalty-a.totalPenalty) ||
           (b.totalFish-a.totalFish) ||
           (b.bestBiggest-a.bestBiggest) ||
           a.name.localeCompare(b.name,'el');
  });

  return out;
}

function computeTeamAggregate(){
  const ind=computeAggregate();
  const byClub=new Map();

  ind.forEach(r=>{
    const c=(r.club||"-").trim()||"-";
    if(!byClub.has(c)) byClub.set(c,[]);
    byClub.get(c).push(r);
  });

  const teams=[];
  byClub.forEach((list,club)=>{
    if(list.length<2) return;

    list.sort((a,b)=>{
      return (b.totalPenalty-a.totalPenalty) ||
             (b.totalFish-a.totalFish) ||
             (b.bestBiggest-a.bestBiggest);
    });

    const best2=list.slice(0,2);
    const teamPenalty=best2[0].totalPenalty+best2[1].totalPenalty;
    const teamFish=best2[0].totalFish+best2[1].totalFish;
    const teamBig=Math.max(best2[0].bestBiggest,best2[1].bestBiggest);

    teams.push({
      club,
      members:best2.map(x=>x.name),
      teamPenalty,
      teamFish,
      teamBig
    });
  });

  teams.sort((a,b)=>{
    return (b.teamPenalty-a.teamPenalty) ||
           (b.teamFish-a.teamFish) ||
           (b.teamBig-a.teamBig) ||
           a.club.localeCompare(b.club,'el');
  });

  return teams;
}

/* ================= Î’Î‘Î˜ÎœÎŸÎ›ÎŸÎ“Î™Î•Î£ UI ================= */
function makeTable(rows,title,headers){
  let html=`<h3 style="margin:6px 0">${safe(title)}</h3><table><thead><tr>`;
  headers.forEach(h=>html+=`<th>${safe(h)}</th>`);
  html+='</tr></thead><tbody>';
  rows.forEach(r=>{
    html+='<tr>'+r.map(c=>`<td>${safe(c)}</td>`).join('')+'</tr>';
  });
  html+='</tbody></table>';
  return html;
}

function renderScores(){
  const tabs=$("scoreTabs"), area=$("scoreTables");
  tabs.innerHTML=""; area.innerHTML="";
  let firstClicked=false;

  state.days.forEach((d,idx)=>{
    const b=document.createElement("button");
    b.className="pill";
    b.textContent=`Î—Î¼Î­ÏÎ± ${idx+1}: ${d.name||""} â€” Î‘Ï„Î¿Î¼Î¹ÎºÏŒ`;
    b.onclick=()=>{
      const rows=computeDayRows(d.id);
      const out=rows.map((r,i)=>[
        i+1,
        r.penalty,
        r.totalFish,
        r.biggest,
        r.name,
        r.club,
        r.regNo,
        r.sponsor,
        r.sector,
        r.peg,
        r.cats[0],r.cats[1],r.cats[2],r.cats[3],r.cats[4],
        r.status
      ]);
      area.innerHTML=makeTable(
        out,
        `ÎšÎ±Ï„Î¬Ï„Î±Î¾Î· Î·Î¼Î­ÏÎ±Ï‚ "${d.name}" (Î Î•Î¡Î™Î£Î£ÎŸÎ¤Î•Î¡ÎŸÎ™ Î’. Î ÎŸÎ™ÎÎ—Î£ â†’ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± ÏˆÎ¬ÏÎ¹Î± â†’ Î¼ÎµÎ³Î±Î»ÏÏ„ÎµÏÎ¿ ÏˆÎ¬ÏÎ¹)`,
        ["#","Î’. Î Î¿Î¹Î½Î®Ï‚","Î£ÏÎ½Î¿Î»Î¿ ÏˆÎ±ÏÎ¹ÏÎ½","ÎœÎµÎ³. ÏˆÎ¬ÏÎ¹(g)","ÎŒÎ½Î¿Î¼Î±","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î‘Ï. ÎœÎ·Ï„ÏÏÎ¿Ï…","Î§Î¿ÏÎ·Î³ÏŒÏ‚","Î¤Î¿Î¼Î­Î±Ï‚","Î˜Î­ÏƒÎ·","Cat1","Cat2","Cat3","Cat4","Cat5","ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·"]
      );
    };
    tabs.appendChild(b);
    if(!firstClicked){ b.click(); firstClicked=true; }
  });

  const bAgg=document.createElement("button");
  bAgg.className="pill";
  bAgg.textContent="Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î‘Ï„Î¿Î¼Î¹ÎºÏŒ (Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î’. Î Î¿Î¹Î½Î®Ï‚)";
  bAgg.onclick=()=>{
    const rows=computeAggregate();
    const out=rows.map((r,i)=>[
      i+1,
      r.totalPenalty,
      r.totalFish,
      r.bestBiggest,
      r.name,
      r.club,
      r.regNo,
      r.sponsor
    ]);
    area.innerHTML=makeTable(
      out,
      "Î£Ï…Î½Î¿Î»Î¹ÎºÎ® Î‘Ï„Î¿Î¼Î¹ÎºÎ® ÎšÎ±Ï„Î¬Ï„Î±Î¾Î· (Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ¿Î¹ ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ¿Î¯ Î²Î±Î¸Î¼Î¿Î¯ Ï€Î¿Î¹Î½Î®Ï‚ ÎºÎ±Î»ÏÏ„ÎµÏÎ±)",
      ["#","Î£ÏÎ½Î¿Î»Î¿ Î’. Î Î¿Î¹Î½Î®Ï‚","Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÏˆÎ¬ÏÎ¹Î±","ÎšÎ±Î»ÏÏ„ÎµÏÎ¿ Î¼ÎµÎ³. ÏˆÎ¬ÏÎ¹(g)","ÎŒÎ½Î¿Î¼Î±","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î‘Ï. ÎœÎ·Ï„ÏÏÎ¿Ï…","Î§Î¿ÏÎ·Î³ÏŒÏ‚"]
    );
  };
  tabs.appendChild(bAgg);
  if(!firstClicked){ bAgg.click(); firstClicked=true; }

  const bTeam=document.createElement("button");
  bTeam.className="pill";
  bTeam.textContent="ÎŸÎ¼Î±Î´Î¹ÎºÏŒ (2 ÎºÎ±Î»ÏÏ„ÎµÏÎ¿Î¹ Î±Î½Î¬ ÏƒÏÎ»Î»Î¿Î³Î¿)";
  bTeam.onclick=()=>{
    const teams=computeTeamAggregate();
    const out=teams.map((t,i)=>[
      i+1,
      t.club,
      t.teamPenalty,
      t.teamFish,
      t.teamBig,
      t.members.join(", ")
    ]);
    area.innerHTML=makeTable(
      out,
      "ÎŸÎ¼Î±Î´Î¹ÎºÏŒ Î ÏÏ‰Ï„Î±Î¸Î»Î®Î¼Î±Ï„Î¿Ï‚ (2 ÎºÎ±Î»ÏÏ„ÎµÏÎ¿Î¹ Î±Î½Î¬ ÏƒÏÎ»Î»Î¿Î³Î¿, Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ¿Î¹ Î²Î±Î¸Î¼Î¿Î¯ Ï€Î¿Î¹Î½Î®Ï‚ ÎºÎ±Î»ÏÏ„ÎµÏÎ±)",
      ["#","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î£ÏÎ½Î¿Î»Î¿ Î’. Î Î¿Î¹Î½Î®Ï‚","Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÏˆÎ¬ÏÎ¹Î±","ÎšÎ±Î»ÏÏ„ÎµÏÎ¿ Î¼ÎµÎ³. ÏˆÎ¬ÏÎ¹(g)","Î‘Î¸Î»Î·Ï„Î­Ï‚ Ï€Î¿Ï… Î¼ÎµÏ„ÏÎ¿ÏÎ½"]
    );
  };
  tabs.appendChild(bTeam);
}

/* ================= Î•ÎÎ‘Î“Î©Î“Î•Î£ ================= */
function exportDrawExcel(){
  const d=activeDay();
  if(!d || !d.draw || !Object.keys(d.draw).length){alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎ»Î®ÏÏ‰ÏƒÎ·.");return;}
  const rows=state.athletes.map(a=>{
    const dd=d.draw[a.id]||{};
    return {
      "ÎŒÎ½Î¿Î¼Î±":a.name,
      "Î£ÏÎ»Î»Î¿Î³Î¿Ï‚":a.club||"",
      "Î‘Ï. ÎœÎ·Ï„ÏÏÎ¿Ï…":a.regNo||"",
      "Î§Î¿ÏÎ·Î³ÏŒÏ‚":a.sponsor||"",
      "Î¤Î¿Î¼Î­Î±Ï‚":dd.sector||"",
      "Î˜Î­ÏƒÎ·":dd.peg||""
    };
  }).sort((x,y)=>{
    return String(x["Î¤Î¿Î¼Î­Î±Ï‚"]).localeCompare(String(y["Î¤Î¿Î¼Î­Î±Ï‚"])) ||
           (Number(x["Î˜Î­ÏƒÎ·"]||999999)-Number(y["Î˜Î­ÏƒÎ·"]||999999));
  });

  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),"ÎšÎ»Î®ÏÏ‰ÏƒÎ·");
  const name=(state.settings.eventName||"Klirosi");
  XLSX.writeFile(wb,`Klirosi_${name}.xlsx`);
}

function exportScoresExcel(){
  const wb=XLSX.utils.book_new();

  const agg=computeAggregate().map((r,i)=>({
    "#":i+1,
    "ÎŒÎ½Î¿Î¼Î±":r.name,
    "Î£ÏÎ»Î»Î¿Î³Î¿Ï‚":r.club,
    "Î‘Ï. ÎœÎ·Ï„ÏÏÎ¿Ï…":r.regNo,
    "Î§Î¿ÏÎ·Î³ÏŒÏ‚":r.sponsor,
    "Î£ÏÎ½Î¿Î»Î¿ Î’. Î Î¿Î¹Î½Î®Ï‚":r.totalPenalty,
    "Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÏˆÎ¬ÏÎ¹Î±":r.totalFish,
    "ÎšÎ±Î»ÏÏ„ÎµÏÎ¿ Î¼ÎµÎ³. ÏˆÎ¬ÏÎ¹(g)":r.bestBiggest
  }));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(agg),"Î‘Ï„Î¿Î¼Î¹ÎºÏŒ-Î£ÏÎ½Î¿Î»Î¿");

  const teams=computeTeamAggregate().map((t,i)=>({
    "#":i+1,
    "Î£ÏÎ»Î»Î¿Î³Î¿Ï‚":t.club,
    "Î£ÏÎ½Î¿Î»Î¿ Î’. Î Î¿Î¹Î½Î®Ï‚":t.teamPenalty,
    "Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÏˆÎ¬ÏÎ¹Î±":t.teamFish,
    "ÎšÎ±Î»ÏÏ„ÎµÏÎ¿ Î¼ÎµÎ³. ÏˆÎ¬ÏÎ¹(g)":t.teamBig,
    "Î‘Î¸Î»Î·Ï„Î­Ï‚":t.members.join(", ")
  }));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(teams),"ÎŸÎ¼Î±Î´Î¹ÎºÏŒ-Î£ÏÎ½Î¿Î»Î¿");

  state.days.forEach(d=>{
    const rows=computeDayRows(d.id).map((r,i)=>({
      "#":i+1,
      "Î’. Î Î¿Î¹Î½Î®Ï‚":r.penalty,
      "Î£ÏÎ½Î¿Î»Î¿ ÏˆÎ±ÏÎ¹ÏÎ½":r.totalFish,
      "ÎœÎµÎ³. ÏˆÎ¬ÏÎ¹(g)":r.biggest,
      "ÎŒÎ½Î¿Î¼Î±":r.name,
      "Î£ÏÎ»Î»Î¿Î³Î¿Ï‚":r.club,
      "Î‘Ï. ÎœÎ·Ï„ÏÏÎ¿Ï…":r.regNo,
      "Î§Î¿ÏÎ·Î³ÏŒÏ‚":r.sponsor,
      "Î¤Î¿Î¼Î­Î±Ï‚":r.sector,
      "Î˜Î­ÏƒÎ·":r.peg,
      "Cat1":r.cats[0],
      "Cat2":r.cats[1],
      "Cat3":r.cats[2],
      "Cat4":r.cats[3],
      "Cat5":r.cats[4],
      "ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·":r.status
    }));
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),d.name||"Î—Î¼Î­ÏÎ±");
  });

  const name=(state.settings.eventName||"Scores");
  XLSX.writeFile(wb,`Scores_${name}.xlsx`);
}

/* ================= IMPORT Î‘Î˜Î›Î—Î¤Î©Î ================= */
function importAthletesFromFile(ev){
  const file=ev.target.files[0];
  if(!file)return;
  const name=file.name.toLowerCase();
  const reader=new FileReader();

  if(name.endsWith(".csv")){
    reader.onload=()=>{
      const lines=reader.result.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      lines.forEach(line=>{
        const parts=line.split(",");
        const nm=(parts[0]||"").trim(); if(!nm)return;
        const club=(parts[1]||"").trim();
        const reg=(parts[2]||"").trim();
        const spo=(parts[3]||"").trim();
        state.athletes.push({id:uid(),name:nm,club,regNo:reg,sponsor:spo});
      });
      save(); renderAll(); ev.target.value="";
    };
    reader.readAsText(file,"utf-8");
  }else{
    reader.onload=e=>{
      const data=new Uint8Array(e.target.result);
      const wb=XLSX.read(data,{type:"array"});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const arr=XLSX.utils.sheet_to_json(ws,{header:1,defval:""});
      arr.forEach((row,idx)=>{
        if(idx===0 && String(row[0]).toLowerCase().includes("Î¿Î½Î¿Î¼Î±")) return;
        const nm=String(row[0]||"").trim(); if(!nm)return;
        const club=String(row[1]||"").trim();
        const reg=String(row[2]||"").trim();
        const spo=String(row[3]||"").trim();
        state.athletes.push({id:uid(),name:nm,club,regNo:reg,sponsor:spo});
      });
      save(); renderAll(); ev.target.value="";
    };
    reader.readAsArrayBuffer(file);
  }
}

/* ================= RENDER ÎŸÎ›Î©Î ================= */
function renderAll(){
  $("eventName").value = state.settings.eventName||"";
  $("numSectors").value = state.settings.numSectors||5;
  renderAthletes();
  renderDaysTabs();
  renderDraw();
  renderResults();
  renderScores();
}

/* ================= Î”Î•Î£Î™ÎœÎŸ EVENTS ================= */
function bindEvents(){
  $("addAthleteBtn").onclick=()=>{
    const name=$("athName").value.trim();
    if(!name) return;
    const club=$("athClub").value.trim();
    const reg=$("athReg").value.trim();
    const spo=$("athSponsor").value.trim();
    state.athletes.push({id:uid(),name,club,regNo:reg,sponsor:spo});
    ["athName","athClub","athReg","athSponsor"].forEach(id=>{$(id).value="";});
    save(); renderAll();
  };

  $("excelBtn").onclick=()=>{$("excelInput").click();};
  $("excelInput").onchange=importAthletesFromFile;

  $("addDayBtn").onclick=()=>{
    const id=uid();
    const idx=state.days.length+1;
    state.days.push({id,name:`Î—Î¼Î­ÏÎ± ${idx}`,draw:{},results:{}});
    state.activeDayId=id;
    save(); renderAll();
  };

  $("drawBtn").onclick=()=>{doDraw(); save(); renderDraw(); renderResults(); renderScores();};
  $("clearDrawBtn").onclick=()=>{
    const d=activeDay();
    if(!d)return;
    d.draw={};
    save(); renderDraw(); renderResults(); renderScores();
  };

  $("exportDrawBtn").onclick=exportDrawExcel;
  $("exportScoresBtn").onclick=exportScoresExcel;

  $("eventName").oninput=e=>{
    state.settings.eventName=e.target.value;
    save();
  };
  $("numSectors").oninput=e=>{
    const v=Math.max(1,Math.min(26,Number(e.target.value)||1));
    state.settings.numSectors=v;
    e.target.value=v;
    save(); renderDraw(); renderResults(); renderScores();
  };

  $("saveStateBtn").onclick=()=>{save();alert("Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÏƒÏ„Î¿Î½ browser (v4).");};
  $("loadStateBtn").onclick=()=>{if(load()) renderAll(); else alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± (v4).");};
  $("resetBtn").onclick=()=>{
    if(confirm("Î£Î¯Î³Î¿Ï…ÏÎ± Î½Î± Î³Î¯Î½ÎµÎ¹ Î¼Î·Î´ÎµÎ½Î¹ÏƒÎ¼ÏŒÏ‚;")){localStorage.removeItem("fishing_katheti_v4"); location.reload();}
  };
}

/* ================= INIT ================= */
window.addEventListener("load",()=>{
  load();
  if(!state.days.length){
    const id=uid();
    state.days.push({id,name:"Î—Î¼Î­ÏÎ± 1",draw:{},results:{}});
    state.activeDayId=id;
  }else if(!state.activeDayId){
    state.activeDayId=state.days[0].id;
  }
  bindEvents();
  showPage("p-participants");
});
</script>

</body>
</html>
